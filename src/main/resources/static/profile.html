<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>个人中心</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f4f7f6;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .profile-container {
            width: 100%;
            max-width: 450px;
            background: #fff;
            padding: 30px 40px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            text-align: center;
        }
        .avatar-wrapper { position: relative; display: inline-block; cursor: pointer; }
        .avatar {
            width: 100px; height: 100px; border-radius: 50%; object-fit: cover;
            border: 3px solid #eee; margin-bottom: 15px;
        }
        .avatar-edit-overlay{
            position: absolute; bottom: 15px; right: 0; width: 30px; height: 30px;
            background: rgba(0,0,0,0.6); color: #fff; border-radius: 50%;
            display: none; justify-content: center; align-items: center; font-size: 14px;
        }
        .form-group { margin-bottom: 20px; text-align: left; }
        .form-group label { display:block; margin-bottom:8px; color:#555; font-weight:bold; }
        .input-wrapper { position: relative; }
        .form-group input {
            width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box;
        }
        .form-group input:disabled { background:#f1f1f1; color:#888; cursor:not-allowed; }
        .password-toggle-icon { position:absolute; top:50%; right:12px; transform:translateY(-50%); cursor:pointer; color:#999; }
        .button-group { display:flex; gap:15px; margin-top:25px; }
        .btn { flex:1; padding:12px; border:none; border-radius:6px; color:#fff; font-size:16px; font-weight:bold; cursor:pointer; transition:background .3s; }
        .btn-primary{ background:#007bff; } .btn-secondary{ background:#6c757d; } .btn-success{ background:#28a745; }
    </style>
</head>
<body>

<div class="profile-container">
    <label for="avatar-upload" class="avatar-wrapper">
        <img src="https://placehold.co/100x100/eee/ccc?text=头像" alt="用户头像" class="avatar" id="avatar">
        <div class="avatar-edit-overlay" id="avatar-edit-overlay"><i class="fa-solid fa-camera"></i></div>
    </label>
    <input type="file" id="avatar-upload" accept="image/*" style="display:none;">

    <!-- 新增：编号（只读） -->
    <div class="form-group">
        <label id="memberNoLabel" for="memberNo">会员编号</label>
        <input type="text" id="memberNo" disabled>
    </div>
    <div class="form-group">
        <label for="nickname">昵称</label>
        <input type="text" id="nickname" disabled>
    </div>
    <!-- 新增：会员地址（ADMIN/MEMBER 可见、可编辑；SHOP_OWNER 隐藏） -->
    <div class="form-group" id="addressGroup">
        <label for="address">地址</label>
        <input type="text" id="address" placeholder="请完善收货地址">
    </div>
    <div class="form-group">
        <label for="email">邮箱</label>
        <input type="email" id="email" disabled>
    </div>
    <div class="form-group">
        <label for="phone">手机号</label>
        <input type="tel" id="phone" disabled>
    </div>

    <div class="form-group" id="password-view-group">
        <label>密码</label>
        <div class="input-wrapper">
            <input type="password" id="password-view" value="********" disabled>
            <i class="fa-solid fa-eye password-toggle-icon" id="password-toggle-icon"></i>
        </div>
    </div>

    <div id="password-edit-groups" style="display:none;">
        <div class="form-group">
            <label for="newPassword">新密码</label>
            <input type="text" id="newPassword" placeholder="留空则不修改密码">
        </div>
    </div>

    <div class="button-group" id="view-mode-buttons">
        <button class="btn btn-primary" id="edit-btn">编辑</button>
        <a href="/index.html" class="btn btn-secondary" style="text-decoration:none;">返回</a>
    </div>

    <div class="button-group" id="edit-mode-buttons" style="display:none;">
        <button class="btn btn-success" id="save-btn">保存</button>
        <button class="btn btn-secondary" id="cancel-btn">取消</button>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DOM 元素 ---
        const avatarImg = document.getElementById('avatar');
        const avatarUpload = document.getElementById('avatar-upload');
        const avatarEditOverlay = document.getElementById('avatar-edit-overlay');

        const nicknameInput = document.getElementById('nickname');
        const emailInput    = document.getElementById('email');
        const phoneInput    = document.getElementById('phone');

        const memberNoInput = document.getElementById('memberNo');
        const memberNoLabel = document.getElementById('memberNoLabel');
        const addressGroup  = document.getElementById('addressGroup');
        const addressInput  = document.getElementById('address');

        const passwordViewGroup  = document.getElementById('password-view-group');
        const passwordEditGroups = document.getElementById('password-edit-groups');
        const newPasswordInput   = document.getElementById('newPassword');
        const passwordViewInput  = document.getElementById('password-view');
        const passwordToggleIcon = document.getElementById('password-toggle-icon');

        const editBtn       = document.getElementById('edit-btn');
        const saveBtn       = document.getElementById('save-btn');
        const cancelBtn     = document.getElementById('cancel-btn');
        const viewButtons   = document.getElementById('view-mode-buttons');
        const editButtons   = document.getElementById('edit-mode-buttons');

        let originalData = {};
        let selectedAvatarFile = null;

        // 生成默认头像
        function generateAvatar(nickname, bgColor) {
            const canvas = document.createElement('canvas');
            canvas.width = 100; canvas.height = 100;
            const ctx = canvas.getContext('2d');
            const colors = ['#f44336','#e91e63','#9c27b0','#673ab7','#3f51b5','#2196f3','#03a9f4','#00bcd4','#009688','#4caf50','#8bc34a','#cddc39','#ffeb3b','#ffc107','#ff9800','#ff5722'];
            const finalBg = bgColor || colors[Math.floor(Math.random()*colors.length)];
            ctx.fillStyle = finalBg; ctx.fillRect(0,0,100,100);
            ctx.font='bold 50px Arial'; ctx.fillStyle='#fff'; ctx.textAlign='center'; ctx.textBaseline='middle';
            ctx.fillText((nickname||'?').charAt(0).toUpperCase(), 50, 50);
            return canvas.toDataURL();
        }

        function enterEditMode() {
            nicknameInput.disabled = false;
            emailInput.disabled    = false;
            phoneInput.disabled    = false;
            // 只有 ADMIN/MEMBER 才能编辑地址；商家隐藏
            addressInput.disabled  = (originalData.role === 'SHOP_OWNER');

            passwordViewGroup.style.display  = 'none';
            passwordEditGroups.style.display = 'block';
            avatarEditOverlay.style.display  = 'flex';

            viewButtons.style.display = 'none';
            editButtons.style.display = 'flex';
            document.querySelector('.avatar-wrapper').setAttribute('for', 'avatar-upload');
        }

        function exitEditMode() {
            // 回填
            nicknameInput.value = originalData.nickname || '';
            emailInput.value    = originalData.email    || '';
            phoneInput.value    = originalData.phone    || '';
            memberNoInput.value = originalData.memberNo || '';
            addressInput.value  = originalData.address  || '';

            // 头像
            if (originalData.avatarUrl) avatarImg.src = originalData.avatarUrl;
            else avatarImg.src = generateAvatar(originalData.nickname, originalData.avatarBgColor);

            // 角色控制：商家隐藏地址，且编号标签显示“商家编号”；其余角色为“会员编号”
            if (originalData.role === 'SHOP_OWNER') {
                addressGroup.style.display = 'none';
                memberNoLabel.textContent  = '商家编号';
            } else {
                addressGroup.style.display = '';
                memberNoLabel.textContent  = '会员编号';
            }

            // 禁用输入
            nicknameInput.disabled = true;
            emailInput.disabled    = true;
            phoneInput.disabled    = true;
            addressInput.disabled  = true;
            memberNoInput.disabled = true;

            // 视图状态
            passwordViewGroup.style.display  = 'block';
            passwordEditGroups.style.display = 'none';
            newPasswordInput.value = '';
            avatarEditOverlay.style.display  = 'none';
            document.querySelector('.avatar-wrapper').removeAttribute('for');
            selectedAvatarFile = null;
            viewButtons.style.display = 'flex';
            editButtons.style.display = 'none';

            // 密码恢复为隐藏
            passwordViewInput.type = 'password';
            passwordViewInput.value = '********';
            passwordToggleIcon.className = 'fa-solid fa-eye-slash password-toggle-icon';
        }

        // 初次加载用户信息
        fetch('/api/users/me', { credentials:'include' })
            .then(r => {
                if (r.status === 401) { alert('请先登录！'); location.href='/login.html'; throw new Error('UNAUTH'); }
                return r.json();
            })
            .then(user => { originalData = user || {}; exitEditMode(); })
            .catch(e => { if (e.message!=='UNAUTH') console.error('获取用户信息失败', e); });

        // 事件：头像预览
        avatarUpload.addEventListener('change', (e)=>{
            if (e.target.files && e.target.files[0]) {
                selectedAvatarFile = e.target.files[0];
                const reader = new FileReader();
                reader.onload = ev => { avatarImg.src = ev.target.result; }
                reader.readAsDataURL(selectedAvatarFile);
            }
        });

        editBtn.addEventListener('click', enterEditMode);
        cancelBtn.addEventListener('click', exitEditMode);

        // 保存
        saveBtn.addEventListener('click', async ()=>{
            try{
                // 1) 上传头像（如有）
                if (selectedAvatarFile){
                    const fd = new FormData(); fd.append('avatar', selectedAvatarFile);
                    const res = await fetch('/api/users/me/avatar', { method:'POST', body:fd, credentials:'include' });
                    if (!res.ok) throw new Error('头像上传失败');
                    const updatedUser = await res.json();
                    originalData = { ...originalData, ...updatedUser };
                }

                // 2) 更新资料（含地址：仅当地址区域可见时才提交）
                const body = {
                    nickname: nicknameInput.value,
                    email:    emailInput.value,
                    phone:    phoneInput.value
                };
                if (addressGroup.style.display !== 'none') {
                    body.address = addressInput.value || '';
                }

                const res2 = await fetch('/api/users/me', {
                    method:'PUT', headers:{'Content-Type':'application/json'},
                    credentials:'include', body: JSON.stringify(body)
                });
                if (!res2.ok) {
                    const t = await res2.text();
                    throw new Error(t || '信息更新失败');
                }

                // 3) 修改密码（可选）
                if (newPasswordInput.value){
                    const res3 = await fetch('/api/users/me/password', {
                        method:'PUT', headers:{'Content-Type':'application/json'},
                        credentials:'include', body: JSON.stringify({ newPassword: newPasswordInput.value })
                    });
                    if (!res3.ok) {
                        const t = await res3.text();
                        throw new Error(t || '密码修改失败');
                    }
                }

                // 4) 重新拉最新用户（确保与 session 同步）
                const fresh = await fetch('/api/users/me', { credentials:'include' }).then(r=>r.json());
                originalData = fresh;
                exitEditMode();
                alert('信息更新成功！');
            }catch(err){
                alert('保存失败：' + err.message);
                exitEditMode();
            }
        });

        // 密码显示/隐藏
        passwordToggleIcon.addEventListener('click', ()=>{
            if (passwordViewInput.type === 'password') {
                passwordViewInput.type = 'text';
                passwordViewInput.value = originalData.password || '********';
                passwordToggleIcon.className = 'fa-solid fa-eye password-toggle-icon';
            } else {
                passwordViewInput.type = 'password';
                passwordViewInput.value = '********';
                passwordToggleIcon.className = 'fa-solid fa-eye-slash password-toggle-icon';
            }
        });
    });
</script>
</body>
</html>
